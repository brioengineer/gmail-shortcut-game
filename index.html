<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Shortcut Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .shortcut-key {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border: 1px solid #ccc;
            border-radius: 0.3rem;
            background-color: #f7f7f7;
            box-shadow: 0 2px 0 #ccc;
            font-weight: 500;
            color: #333;
            margin: 0 0.25rem;
        }
        .feedback-animation {
            animation: pop-in 0.3s ease-out;
        }
        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .shortcut-checkbox:checked + label {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="game-container" class="w-full max-w-4xl mx-auto">
        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold text-gray-800">Gmail Shortcut Challenge</h1>
            <p id="subtitle" class="text-gray-600 mt-2">Select the shortcuts you want to practice.</p>
        </div>

        <!-- Game Setup Screen -->
        <div id="game-setup" class="bg-white rounded-lg shadow-xl p-6">
            <h2 class="text-2xl font-bold text-center mb-4">Choose Your Challenge</h2>
            <div id="shortcut-selection" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6">
                <!-- Checkboxes will be dynamically inserted here -->
            </div>
            <div class="flex justify-center items-center gap-4">
                 <button id="start-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">Start Timed Challenge</button>
                 <button id="leaderboard-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">View Leaderboard</button>
            </div>
             <p id="selection-error" class="text-red-500 text-center mt-4 hidden">Please select at least one shortcut to practice.</p>
        </div>
        
        <!-- Game UI -->
        <div id="game-ui" class="bg-white rounded-lg shadow-xl p-6 relative hidden">
            <!-- Score and Instruction -->
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <div id="instruction-card" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md w-full">
                    <p class="font-bold">Your task:</p>
                    <p id="instruction-text" class="text-lg">Click "Start Game" to begin!</p>
                </div>
                 <div class="text-right ml-4 flex-shrink-0 space-y-2">
                    <div>
                        <div class="text-sm text-gray-500">PROGRESS</div>
                        <div id="progress" class="text-3xl font-bold text-gray-800">0/15</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">TIME</div>
                        <div id="timer" class="text-3xl font-bold text-gray-800">0.0s</div>
                    </div>
                     <div>
                        <div class="text-sm text-gray-500">BEST TIME</div>
                        <div id="best-time" class="text-3xl font-bold text-gray-800">-</div>
                    </div>
                </div>
            </div>

            <!-- Mock Email -->
            <div id="email-view">
                <div class="flex items-center justify-between mb-3">
                    <h2 id="email-subject" class="text-2xl font-semibold text-gray-800">Welcome to the Challenge!</h2>
                </div>
                <div class="flex items-center space-x-3 mb-6">
                    <div class="w-10 h-10 bg-green-500 text-white flex items-center justify-center rounded-full font-bold" id="email-avatar">G</div>
                    <div>
                        <div class="font-bold text-gray-700" id="email-sender">Game Master</div>
                        <div class="text-sm text-gray-500">to me</div>
                    </div>
                </div>
                <div id="email-body" class="text-gray-600 leading-relaxed">
                    <p>An instruction will appear at the top. Your job is to press the correct keyboard shortcut.</p>
                </div>
            </div>

            <!-- Feedback Overlay -->
            <div id="feedback-overlay" class="absolute inset-0 bg-white bg-opacity-80 flex-col items-center justify-center rounded-lg text-center p-8 hidden">
                <div id="feedback-icon" class="text-6xl mb-4"></div>
                <div id="feedback-text" class="text-3xl font-bold"></div>
                <div id="feedback-hint" class="text-lg text-gray-600 mt-2"></div>
            </div>
        </div>

        <div id="end-game-controls" class="text-center mt-6 hidden">
             <button id="play-again-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">Play Again</button>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg">
            <div class="flex justify-between items-center border-b p-4">
                <h3 class="text-2xl font-bold">Top 10 Players</h3>
                <button id="close-leaderboard-button" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="p-6">
                <table class="w-full text-left">
                    <thead>
                        <tr>
                            <th class="p-2">Rank</th>
                            <th class="p-2">Name</th>
                            <th class="p-2">Time (s)</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Scores will be inserted here -->
                    </tbody>
                </table>
                <p id="leaderboard-loading" class="text-center text-gray-500 mt-4">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Submit Score Modal -->
    <div id="submit-score-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-6 text-center">
            <h3 class="text-2xl font-bold mb-2">New Best Time!</h3>
            <p class="text-gray-600 mb-4">Enter your name to join the leaderboard.</p>
            <input type="text" id="player-name-input" placeholder="Your Name" class="w-full border-2 border-gray-300 rounded-md p-2 mb-4 focus:border-blue-500 focus:outline-none">
            <button id="submit-score-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg w-full">Submit Score</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- Firebase Setup ---
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let db, auth;
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }

            // --- DOM Elements ---
            const instructionText = document.getElementById('instruction-text');
            const progressEl = document.getElementById('progress');
            const timerEl = document.getElementById('timer');
            const bestTimeEl = document.getElementById('best-time');
            const startButton = document.getElementById('start-button');
            const playAgainButton = document.getElementById('play-again-button');
            const feedbackOverlay = document.getElementById('feedback-overlay');
            const feedbackIcon = document.getElementById('feedback-icon');
            const feedbackText = document.getElementById('feedback-text');
            const feedbackHint = document.getElementById('feedback-hint');
            const emailSubject = document.getElementById('email-subject');
            const emailSender = document.getElementById('email-sender');
            const emailAvatar = document.getElementById('email-avatar');
            const emailBody = document.getElementById('email-body');
            const gameSetup = document.getElementById('game-setup');
            const gameUi = document.getElementById('game-ui');
            const subtitle = document.getElementById('subtitle');
            const shortcutSelectionContainer = document.getElementById('shortcut-selection');
            const selectionError = document.getElementById('selection-error');
            const endGameControls = document.getElementById('end-game-controls');
            
            // Leaderboard elements
            const leaderboardButton = document.getElementById('leaderboard-button');
            const leaderboardModal = document.getElementById('leaderboard-modal');
            const closeLeaderboardButton = document.getElementById('close-leaderboard-button');
            const leaderboardBody = document.getElementById('leaderboard-body');
            const leaderboardLoading = document.getElementById('leaderboard-loading');
            
            // Submit score elements
            const submitScoreModal = document.getElementById('submit-score-modal');
            const playerNameInput = document.getElementById('player-name-input');
            const submitScoreButton = document.getElementById('submit-score-button');

            // --- Game State ---
            let bestTime = null;
            let activeChallenge = null;
            let gameActive = false;
            let challenges = [];
            let timerInterval = null;
            let startTime = 0;
            let completedChallenges = 0;
            let lastGameTime = 0;
            const CHALLENGE_COUNT = 15;

            // --- Game Data ---
            const allShortcuts = [
                { key: 'c', code: 'KeyC', shift: false, description: 'Compose' },
                { key: 'd', code: 'KeyD', shift: false, description: 'Compose in new tab' },
                { key: 'r', code: 'KeyR', shift: false, description: 'Reply' },
                { key: 'a', code: 'KeyA', shift: false, description: 'Reply all' },
                { key: 'e', code: 'KeyE', shift: false, description: 'Archive' },
                { key: 'l', code: 'KeyL', shift: false, description: 'Label' },
                { key: 'v', code: 'KeyV', shift: false, description: 'Move' },
                { key: 's', code: 'KeyS', shift: false, description: 'Star' },
                { key: '#', code: 'Digit3', shift: true, description: 'Delete' },
                { key: '!', code: 'Digit1', shift: true, description: 'Report spam' },
                { key: 'z', code: 'KeyZ', shift: false, description: 'Undo' },
                { key: 'shift + t', code: 'KeyT', shift: true, description: 'Create task' },
                { key: 'j', code: 'KeyJ', shift: false, description: 'Next message' },
                { key: 'k', code: 'KeyK', shift: false, description: 'Previous message' },
                { key: 'o', code: 'KeyO', shift: false, description: 'Open message' },
                { key: 'u', code: 'KeyU', shift: false, description: 'Back to threadlist' },
                { key: '/', code: 'Slash', shift: false, description: 'Search mail' },
                { key: 'g then i', sequence: ['KeyG', 'KeyI'], description: 'Go to Inbox' },
            ];

            const mockEmails = [
                { subject: "Project Update", sender: "Alice", body: "Latest updates on Project Phoenix are attached." },
                { subject: "Team Lunch?", sender: "Bob", body: "Are we still on for lunch this Friday?" },
                { subject: "Weekly Report", sender: "Charlie", body: "Please find the weekly performance report attached." },
                { subject: "Your recent order", sender: "Online Store", body: "Your items have been shipped!" },
            ];

            // --- Initial Setup ---
            const initializeSetup = () => {
                loadBestTime();
                shortcutSelectionContainer.innerHTML = '';
                allShortcuts.forEach((sc, index) => {
                    const div = document.createElement('div');
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = `sc-${index}`;
                    input.value = index;
                    input.checked = true;
                    input.className = 'hidden shortcut-checkbox';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `sc-${index}`;
                    label.className = 'block border-2 border-gray-300 rounded-lg p-3 text-center cursor-pointer transition-all duration-200 h-full';
                    label.innerHTML = `<span class="font-bold text-lg">${sc.key}</span><br><span class="text-sm text-gray-600">${sc.description}</span>`;
                    
                    div.appendChild(input);
                    div.appendChild(label);
                    shortcutSelectionContainer.appendChild(div);
                });
            };

            const loadBestTime = () => {
                bestTime = localStorage.getItem('gmailShortcutBestTime');
                bestTimeEl.textContent = bestTime ? `${parseFloat(bestTime).toFixed(1)}s` : '-';
            };
            
            // --- Game Logic ---
            const startGame = () => {
                const selectedIndexes = Array.from(shortcutSelectionContainer.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
                if (selectedIndexes.length === 0) {
                    selectionError.classList.remove('hidden');
                    return;
                }
                selectionError.classList.add('hidden');

                const selectedShortcuts = selectedIndexes.map(i => allShortcuts[i]);
                challenges = [];
                for(let i=0; i < CHALLENGE_COUNT; i++) {
                    challenges.push(selectedShortcuts[Math.floor(Math.random() * selectedShortcuts.length)]);
                }

                gameActive = true;
                completedChallenges = 0;
                updateProgress();
                
                gameSetup.classList.add('hidden');
                gameUi.classList.remove('hidden');
                endGameControls.classList.add('hidden');
                subtitle.textContent = "Press the correct key to complete the action. How fast can you go?";

                startTime = Date.now();
                timerInterval = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000;
                    timerEl.textContent = `${elapsed.toFixed(1)}s`;
                }, 100);

                nextChallenge();
            };

            const nextChallenge = () => {
                if (completedChallenges >= CHALLENGE_COUNT) {
                    endGame();
                    return;
                }
                completedChallenges++;
                updateProgress();

                activeChallenge = challenges.pop();
                const email = mockEmails[Math.floor(Math.random() * mockEmails.length)];
                instructionText.textContent = activeChallenge.description;
                emailSubject.textContent = email.subject;
                emailSender.textContent = email.sender;
                emailAvatar.textContent = email.sender.charAt(0).toUpperCase();
                emailBody.innerHTML = `<p>${email.body}</p>`;
            };
            
            const endGame = () => {
                clearInterval(timerInterval);
                const finalTime = (Date.now() - startTime) / 1000;
                gameActive = false;
                lastGameTime = finalTime;
                
                timerEl.textContent = `${finalTime.toFixed(1)}s`;
                let endMessage = `Finished! Your time: ${finalTime.toFixed(1)} seconds.`;

                if (bestTime === null || finalTime < parseFloat(bestTime)) {
                    bestTime = finalTime.toFixed(1);
                    localStorage.setItem('gmailShortcutBestTime', bestTime);
                    bestTimeEl.textContent = `${bestTime}s`;
                    endMessage += ' 🎉 New Best Time!';
                    submitScoreModal.classList.remove('hidden'); // Show submit modal
                }
                
                instructionText.textContent = endMessage;
                subtitle.textContent = "Great job! Click 'Play Again' to try and beat your best time.";
                endGameControls.classList.remove('hidden');
            };

            const resetToSetup = () => {
                gameUi.classList.add('hidden');
                endGameControls.classList.add('hidden');
                gameSetup.classList.remove('hidden');
                subtitle.textContent = 'Select the shortcuts you want to practice.';
                timerEl.textContent = "0.0s";
                completedChallenges = 0;
                updateProgress();
            };

            const handleCorrectAnswer = () => {
                showFeedback(true);
                setTimeout(() => {
                    feedbackOverlay.classList.add('hidden');
                    nextChallenge();
                }, 800);
            };

            const handleWrongAnswer = (pressedKey) => {
                showFeedback(false, pressedKey);
                setTimeout(() => {
                    feedbackOverlay.classList.add('hidden');
                }, 1200);
            };

            const showFeedback = (isCorrect, pressedKey = '') => {
                feedbackOverlay.classList.remove('hidden');
                feedbackOverlay.classList.add('flex', 'feedback-animation');
                if (isCorrect) {
                    feedbackIcon.innerHTML = '✅';
                    feedbackIcon.style.color = '#10B981';
                    feedbackText.textContent = 'Correct!';
                    feedbackHint.innerHTML = '';
                } else {
                    feedbackIcon.innerHTML = '❌';
                    feedbackIcon.style.color = '#EF4444';
                    feedbackText.textContent = 'Not quite!';
                    feedbackHint.innerHTML = `You pressed <span class="shortcut-key">${pressedKey}</span>. The correct shortcut is <span class="shortcut-key">${activeChallenge.key}</span>.`;
                }
            };
            
            const updateProgress = () => {
                progressEl.textContent = `${completedChallenges}/${CHALLENGE_COUNT}`;
            };
            
            // --- Leaderboard Logic ---
            const showLeaderboard = async () => {
                leaderboardModal.classList.remove('hidden');
                leaderboardLoading.classList.remove('hidden');
                leaderboardBody.innerHTML = '';

                try {
                    const leaderboardCol = collection(db, `/artifacts/${appId}/public/data/leaderboard`);
                    const snapshot = await getDocs(leaderboardCol);
                    const scores = snapshot.docs.map(doc => doc.data());

                    scores.sort((a, b) => a.time - b.time);

                    const top10 = scores.slice(0, 10);
                    
                    leaderboardBody.innerHTML = top10.map((score, index) => `
                        <tr class="border-b">
                            <td class="p-2">${index + 1}</td>
                            <td class="p-2">${score.name}</td>
                            <td class="p-2">${score.time.toFixed(1)}</td>
                        </tr>
                    `).join('');

                } catch (err) {
                    console.error("Error fetching leaderboard: ", err);
                    leaderboardBody.innerHTML = `<tr><td colspan="3" class="text-center p-4">Could not load leaderboard.</td></tr>`;
                } finally {
                    leaderboardLoading.classList.add('hidden');
                }
            };

            const submitScore = async () => {
                const playerName = playerNameInput.value.trim();
                if (!playerName) {
                    alert("Please enter a name.");
                    return;
                }

                submitScoreButton.disabled = true;
                submitScoreButton.textContent = "Submitting...";
                
                try {
                    const leaderboardCol = collection(db, `/artifacts/${appId}/public/data/leaderboard`);
                    await addDoc(leaderboardCol, {
                        name: playerName,
                        time: lastGameTime,
                        createdAt: serverTimestamp()
                    });
                } catch(err) {
                    console.error("Error submitting score: ", err);
                } finally {
                    submitScoreModal.classList.add('hidden');
                    submitScoreButton.disabled = false;
                    submitScoreButton.textContent = "Submit Score";
                    playerNameInput.value = '';
                }
            };

            // --- Event Listeners ---
            startButton.addEventListener('click', startGame);
            playAgainButton.addEventListener('click', resetToSetup);
            leaderboardButton.addEventListener('click', showLeaderboard);
            closeLeaderboardButton.addEventListener('click', () => leaderboardModal.classList.add('hidden'));
            submitScoreButton.addEventListener('click', submitScore);

            document.addEventListener('keydown', (e) => {
                if (!gameActive || e.repeat) return;
                
                if (e.key !== 'F5' && e.key !== 'F12') e.preventDefault();
                
                let correctCode = activeChallenge.code;
                if (activeChallenge.key === '#') correctCode = 'Digit3';
                if (activeChallenge.key === '!') correctCode = 'Digit1';

                if (e.code === correctCode && e.shiftKey === activeChallenge.shift) {
                    handleCorrectAnswer();
                } else {
                    let pressed = (e.shiftKey ? 'shift + ' : '') + (e.ctrlKey ? 'ctrl + ' : '') + (e.altKey ? 'alt + ' : '') + e.key.toLowerCase();
                    if (!['shift', 'control', 'alt'].includes(e.key.toLowerCase())) {
                       handleWrongAnswer(pressed);
                    }
                }
            });

            initializeSetup();
        });
    </script>
</body>
</html>

